@isTest
private class BUP_IncomeTransactionEntryControllerTest {

    @testSetup
    static void setupData() {
        // Create Account
        Account acc = new Account(Name = 'Test Account');
        insert acc;

        // Create Contact linked to Account
        Contact con = new Contact(
            FirstName = 'Test', 
            LastName = 'Donor', 
            Email = 'test@example.com', 
            AccountId = acc.Id
        );
        insert con;

        // Create Income Budget
        Income_Budget__c ib = new Income_Budget__c(
            Name = 'General Budget',
            Fiscal_Year__c = '25/26_FY' // Valid picklist value
        );
        insert ib;

        // Create Recurring Donations
        List<Recurring_Donation__c> rds = new List<Recurring_Donation__c>();
        
        // Active Donation
        rds.add(new Recurring_Donation__c(
            Name = 'Active Donation',
            Contact__c = con.Id,
            Promised_Donation_Amount__c = 1000,
            Status__c = 'Active',
            Description__c = 'Test Active',
            Income_Budget__c = ib.Id,
            Fiscal_Year__c = '25/26_FY'
        ));

        // Inactive Donation
        rds.add(new Recurring_Donation__c(
            Name = 'Closed Donation',
            Contact__c = con.Id,
            Promised_Donation_Amount__c = 500,
            Status__c = 'Cancelled', // Changed from Closed to Cancelled
            Description__c = 'Test Closed',
            Income_Budget__c = ib.Id,
            Fiscal_Year__c = '25/26_FY'
        ));

        insert rds;
    }

    @isTest
    static void testSearchContacts() {
        // Test matching search
        Test.startTest();
        List<Contact> results = BUP_IncomeTransactionEntryController.searchContacts('Donor');
        Test.stopTest();

        Assert.areEqual(1, results.size(), 'Should find 1 contact');
        Assert.areEqual('Test Account', results[0].Account.Name, 'Should return Account Name');

        // Test non-matching search
        List<Contact> emptyResults = BUP_IncomeTransactionEntryController.searchContacts('NonExistent');
        Assert.areEqual(0, emptyResults.size(), 'Should find 0 contacts');

        // Test blank search
        List<Contact> blankResults = BUP_IncomeTransactionEntryController.searchContacts('');
        Assert.areEqual(0, blankResults.size(), 'Should return empty list for blank search');
    }

    @isTest
    static void testGetRecurringDonations() {
        Contact con = [SELECT Id FROM Contact LIMIT 1];

        Test.startTest();
        List<Recurring_Donation__c> donations = BUP_IncomeTransactionEntryController.getRecurringDonations(con.Id);
        Test.stopTest();

        // Should only return the Active one
        Assert.areEqual(1, donations.size(), 'Should only return active donations');
        // Name is auto-generated by system
        Assert.areEqual('25/26_FY - Test Donor - Recurring Donation', donations[0].Name, 'Should be the active donation');
    }

    @isTest
    static void testCreateIncomeTransaction() {
        Contact con = [SELECT Id, AccountId FROM Contact LIMIT 1];
        Recurring_Donation__c rd = [SELECT Id FROM Recurring_Donation__c WHERE Status__c = 'Active' LIMIT 1];

        Decimal amount = 100.00;
        Date incDate = Date.today();
        String description = 'Payment 1';

        Test.startTest();
        BUP_IncomeTransactionEntryController.createIncomeTransaction(
            rd.Id, 
            con.Id, 
            amount, 
            incDate, 
            description
        );
        Test.stopTest();

        // Verify Transaction
        Income_Transaction__c it = [
            SELECT Id, Amount__c, Income_Date__c, Description__c, 
                   Contact__c, Account__c, Recurring_Donation__c, Income_Type__c 
            FROM Income_Transaction__c 
            LIMIT 1
        ];

        Assert.areEqual(amount, it.Amount__c);
        Assert.areEqual(incDate, it.Income_Date__c);
        Assert.areEqual(description, it.Description__c);
        Assert.areEqual(con.Id, it.Contact__c);
        Assert.areEqual(con.AccountId, it.Account__c, 'Account should be inferred from Contact');
        Assert.areEqual(rd.Id, it.Recurring_Donation__c);
        Assert.areEqual('Recurring Donation', it.Income_Type__c);
    }
}